<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AITA â€” Cast Your Judgment</title>

    <!-- Open Graph for link previews -->
    <meta property="og:title" content="AITA â€” Judge Real-Life Conflicts">
    <meta property="og:description" content="Cast your vote on this case. Who's wrong here?">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aitaapp.link">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&display=swap');

        :root {
            --gradient-top: #D946EF;
            --gradient-mid: #EC4899;
            --gradient-bottom: #F97316;
            --purple-brand: #7C3AED;
            --purple-light: #A78BFA;
            --teal-brand: #0D9488;
            --teal-light: #14B8A6;
        }

        html, body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            min-height: 100dvh;
            background: linear-gradient(175deg, var(--gradient-top) 0%, var(--gradient-mid) 35%, var(--gradient-bottom) 100%);
            overflow-x: hidden;
        }

        /* â”€â”€ Skeleton Loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite ease-in-out;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* â”€â”€ Vote option styling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .vote-option {
            border: 2px solid #E5E7EB;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .vote-option:hover {
            border-color: #D1D5DB;
            background: #FAFAFA;
        }
        .vote-option:active {
            transform: scale(0.97);
        }
        .vote-option.selected {
            border-color: var(--purple-brand);
            background: rgba(124, 58, 237, 0.04);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15);
        }

        /* â”€â”€ Submit button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-submit {
            background: linear-gradient(135deg, #7C3AED, #8B5CF6, #A78BFA);
            transition: all 0.25s ease;
        }
        .btn-submit:disabled {
            background: #E5E7EB;
            color: #9CA3AF;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-submit:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }
        .btn-submit:not(:disabled):active {
            transform: translateY(0);
        }

        /* â”€â”€ CTA download button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-download {
            background: #111827;
            transition: all 0.2s ease;
        }
        .btn-download:hover {
            background: #1F2937;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .btn-download:active {
            transform: translateY(0);
        }

        /* â”€â”€ Thick Result Bars (App-Style) â”€â”€â”€â”€ */
        .result-bar-track {
            position: relative;
            height: 48px;
            border-radius: 9999px;
            overflow: hidden;
            background: #F3F4F6;
        }
        .result-bar-fill {
            position: absolute;
            top: 0; left: 0;
            height: 100%;
            border-radius: 9999px;
            min-width: 0%;
            transition: min-width 0.9s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .result-bar-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding: 0 18px;
        }
        .result-bar-label {
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
        }
        .result-bar-pct {
            font-size: 16px;
            font-weight: 800;
            white-space: nowrap;
        }
        .your-vote-pill {
            display: inline-flex;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            padding: 2px 7px;
            border-radius: 9999px;
            margin-left: 6px;
        }

        /* â”€â”€ Fade-in animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ Card subtle entrance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card-enter {
            animation: cardSlideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes cardSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* â”€â”€ DUEL MODE STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .duel-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 14px;
            border-radius: 9999px;
            background: linear-gradient(135deg, var(--teal-brand), var(--teal-light));
            color: white;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 0.6px;
            text-transform: uppercase;
        }

        /* Tab switcher (mirrors the app's Side A / Side B tabs) */
        .duel-tabs {
            display: flex;
            background: #F3F4F6;
            border-radius: 12px;
            padding: 3px;
        }
        .duel-tab {
            flex: 1;
            padding: 10px 6px;
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #9CA3AF;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .duel-tab.active-a {
            background: var(--purple-brand);
            color: #fff;
            box-shadow: 0 2px 8px rgba(124,58,237,0.3);
        }
        .duel-tab.active-b {
            background: var(--teal-brand);
            color: #fff;
            box-shadow: 0 2px 8px rgba(13,148,136,0.3);
        }

        /* Story panels */
        .duel-panel { display: none; }
        .duel-panel.active {
            display: block;
            animation: fadeIn 0.25s ease forwards;
        }

        /* Side cards */
        .side-card {
            border-radius: 14px;
            padding: 16px 18px;
        }
        .side-card.side-a {
            background: #F5F3FF;
            border-left: 4px solid var(--purple-brand);
        }
        .side-card.side-b {
            background: #F0FDFA;
            border-left: 4px solid var(--teal-brand);
        }
        .side-label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 9px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .side-label.label-a {
            background: rgba(124,58,237,0.1);
            color: var(--purple-brand);
        }
        .side-label.label-b {
            background: rgba(13,148,136,0.1);
            color: var(--teal-brand);
        }
    </style>
</head>
<body>

<!-- ================================================================ -->
<!-- MAIN CONTAINER                                                    -->
<!-- ================================================================ -->
<div id="app" class="flex flex-col items-center min-h-dvh px-4 py-8 pb-12">

    <!-- â”€â”€ LOADING STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="loading-state" class="w-full max-w-md mt-8">
        <div class="bg-white rounded-3xl p-6 shadow-xl">
            <!-- Avatar skeleton -->
            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                <div class="skeleton w-11 h-11 rounded-full shrink-0"></div>
                <div class="flex flex-col gap-2">
                    <div class="skeleton w-24 h-3"></div>
                    <div class="skeleton w-36 h-4"></div>
                </div>
            </div>
            <!-- Title skeleton -->
            <div class="skeleton w-full h-6 mb-3"></div>
            <div class="skeleton w-3/4 h-6 mb-6"></div>
            <!-- Body skeleton -->
            <div class="skeleton w-full h-4 mb-2"></div>
            <div class="skeleton w-full h-4 mb-2"></div>
            <div class="skeleton w-5/6 h-4 mb-2"></div>
            <div class="skeleton w-full h-4 mb-2"></div>
            <div class="skeleton w-2/3 h-4 mb-8"></div>
            <!-- Vote button skeletons -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="skeleton h-24 rounded-2xl"></div>
                <div class="skeleton h-24 rounded-2xl"></div>
                <div class="skeleton h-24 rounded-2xl"></div>
                <div class="skeleton h-24 rounded-2xl"></div>
            </div>
            <div class="skeleton w-full h-14 rounded-2xl"></div>
        </div>
    </div>

    <!-- â”€â”€ CASE CARD (hidden until loaded) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="case-card" class="w-full max-w-md mt-6 hidden">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden card-enter">

            <!-- Header bar -->
            <div id="card-header" class="flex items-center gap-3 px-6 pt-6 pb-4 border-b border-gray-100">
                <div class="w-11 h-11 bg-gray-200 rounded-full flex items-center justify-center shrink-0">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-400 font-medium leading-tight">@anonymous</p>
                    <p class="text-base font-bold text-gray-800 leading-tight">cast your judgment!</p>
                </div>
            </div>

            <!-- Case content -->
            <div class="px-6 pt-5 pb-6">

                <!-- Duel badge (injected by JS when duel detected) -->
                <div id="duel-badge-slot" class="hidden flex justify-center mb-4">
                    <span class="duel-badge">âš”ï¸ Duel Case</span>
                </div>

                <!-- Title -->
                <h1 id="case-title" class="text-xl font-extrabold text-gray-900 leading-snug mb-4"></h1>

                <!-- â•â•â• STANDARD BODY (visible for normal cases) â•â•â• -->
                <div id="standard-body">
                    <p id="case-body" class="text-base text-gray-500 leading-relaxed mb-6" style="white-space: pre-line;"></p>
                </div>

                <!-- â•â•â• DUEL BODY (hidden by default, shown for duels) â•â•â• -->
                <div id="duel-body" class="hidden mb-6">
                    <!-- Tabs -->
                    <div class="duel-tabs mb-4">
                        <div id="tab-a" class="duel-tab active-a" onclick="switchSide('a')">Side A's Story</div>
                        <div id="tab-b" class="duel-tab" onclick="switchSide('b')">Side B's Story</div>
                    </div>
                    <!-- Panel A -->
                    <div id="panel-a" class="duel-panel active">
                        <div class="side-card side-a">
                            <div class="side-label label-a">ğŸ“ Side A â€” The Poster</div>
                            <p id="duel-story-a" class="text-base text-gray-600 leading-relaxed" style="white-space: pre-line;"></p>
                        </div>
                    </div>
                    <!-- Panel B -->
                    <div id="panel-b" class="duel-panel">
                        <div class="side-card side-b">
                            <div class="side-label label-b">âš¡ Side B â€” The Opponent</div>
                            <p id="duel-story-b" class="text-base text-gray-600 leading-relaxed" style="white-space: pre-line;"></p>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ VOTING SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <div id="vote-section">
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="vote-option flex flex-col items-center justify-center py-5 px-3"
                             data-vote="yta" onclick="selectVote('yta')">
                            <span class="text-3xl mb-1.5">ğŸš«</span>
                            <span class="text-sm font-bold text-gray-700">You're Wrong</span>
                        </div>
                        <div class="vote-option flex flex-col items-center justify-center py-5 px-3"
                             data-vote="nta" onclick="selectVote('nta')">
                            <span class="text-3xl mb-1.5">âŒ</span>
                            <span class="text-sm font-bold text-gray-700">They're Wrong</span>
                        </div>
                        <div class="vote-option flex flex-col items-center justify-center py-5 px-3"
                             data-vote="esh" onclick="selectVote('esh')">
                            <span class="text-3xl mb-1.5">ğŸ’¥</span>
                            <span class="text-sm font-bold text-gray-700">Everyone Sucks</span>
                        </div>
                        <div class="vote-option flex flex-col items-center justify-center py-5 px-3"
                             data-vote="nah" onclick="selectVote('nah')">
                            <span class="text-3xl mb-1.5">âœ…</span>
                            <span class="text-sm font-bold text-gray-700">No One Sucks</span>
                        </div>
                    </div>

                    <button id="submit-btn" class="btn-submit w-full py-4 rounded-2xl text-white font-bold text-lg tracking-wide disabled:opacity-100"
                            disabled onclick="submitVote()">
                        Submit Vote
                    </button>
                </div>

                <!-- â”€â”€ RESULTS SECTION (hidden until voted) â”€â”€ -->
                <div id="results-section" class="hidden fade-in">
                    <div class="text-center mb-6">
                        <p class="text-lg font-bold text-green-600 mb-1">âœ“ Vote submitted!</p>
                        <p class="text-sm text-gray-400">Thanks for casting your judgment</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ ANONYM JUDGMENT label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="text-center mt-5">
            <span class="text-sm font-semibold text-white/80">
                anonym judgment
            </span>
        </div>

        <!-- â”€â”€ SOCIAL PROOF counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="vote-counter" class="text-center mt-10 hidden">
            <p class="text-lg font-bold text-white">
                ğŸ‘‡ <span id="total-votes-display">0</span> people have judged this case ğŸ‘‡
            </p>
        </div>

        <!-- â”€â”€ CTA: Download App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="mt-6 w-full">
            <a id="download-btn" href="https://apps.apple.com/app/aita/id0000000000"
               class="btn-download block w-full py-4 rounded-full text-white font-bold text-lg text-center tracking-wide">
                Share Your Own Story!
            </a>
        </div>

        <!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="flex items-center justify-center gap-6 mt-6 pb-4">
            <a href="https://www.tapmediagroup.com/aita/termsofservice" target="_blank" class="text-sm text-white/60 hover:text-white/90 transition-colors">Terms</a>
            <a href="https://www.tapmediagroup.com/aita/privacypolicy" target="_blank" class="text-sm text-white/60 hover:text-white/90 transition-colors">Privacy</a>
        </div>
    </div>

    <!-- â”€â”€ ERROR STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="error-state" class="w-full max-w-md mt-16 text-center hidden">
        <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8">
            <p class="text-5xl mb-4">âš–ï¸</p>
            <h2 class="text-xl font-bold text-white mb-2">Case Not Found</h2>
            <p class="text-white/70 mb-8 text-sm leading-relaxed">This case may have been removed or the link is invalid. But you can still judge real-life conflicts in the app!</p>
            <a href="https://apps.apple.com/app/aita/id0000000000"
               class="btn-download inline-block px-8 py-4 rounded-full text-white font-bold text-lg">
                Download AITA
            </a>
        </div>
    </div>

</div>


<!-- ================================================================ -->
<!-- JAVASCRIPT                                                        -->
<!-- ================================================================ -->
<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL  = 'https://mnebpvhyjlasnwnmhuxm.supabase.co';
const SUPABASE_ANON = 'sb_publishable_m81YwqXOF5DjNh0ker0WZw_2g_jtwyi';

const APP_STORE_URL = 'https://apps.apple.com/us/app/aita-whos-right/id6758395005';

// â”€â”€â”€ INIT SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCaseId  = null;
let selectedVote   = null;
let isSubmitting   = false;
let deviceId       = null;

// â”€â”€â”€ DOM REFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $loading      = document.getElementById('loading-state');
const $caseCard     = document.getElementById('case-card');
const $errorState   = document.getElementById('error-state');
const $title        = document.getElementById('case-title');
const $body         = document.getElementById('case-body');
const $voteSection  = document.getElementById('vote-section');
const $results      = document.getElementById('results-section');
const $submitBtn    = document.getElementById('submit-btn');
const $voteCounter  = document.getElementById('vote-counter');
const $totalVotes   = document.getElementById('total-votes-display');

// Duel-specific refs
const $duelBadge    = document.getElementById('duel-badge-slot');
const $standardBody = document.getElementById('standard-body');
const $duelBody     = document.getElementById('duel-body');
const $duelStoryA   = document.getElementById('duel-story-a');
const $duelStoryB   = document.getElementById('duel-story-b');
const $tabA         = document.getElementById('tab-a');
const $tabB         = document.getElementById('tab-b');
const $panelA       = document.getElementById('panel-a');
const $panelB       = document.getElementById('panel-b');

// â”€â”€â”€ DEVICE ID (persistent fingerprint) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getOrCreateDeviceId() {
    const KEY = 'aita_device_id';
    let id = localStorage.getItem(KEY);
    if (!id) {
        id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        localStorage.setItem(KEY, id);
    }
    return id;
}

// â”€â”€â”€ DUEL TAB SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchSide(side) {
    if (side === 'a') {
        $tabA.className  = 'duel-tab active-a';
        $tabB.className  = 'duel-tab';
        $panelA.className = 'duel-panel active';
        $panelB.className = 'duel-panel';
    } else {
        $tabA.className  = 'duel-tab';
        $tabB.className  = 'duel-tab active-b';
        $panelA.className = 'duel-panel';
        $panelB.className = 'duel-panel active';
    }
}

// â”€â”€â”€ ON PAGE LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', init);

async function init() {
    // Initialize device ID for anti-spam
    deviceId = getOrCreateDeviceId();

    // Update all download links
    document.querySelectorAll('a[href*="apps.apple.com"]').forEach(a => {
        a.href = APP_STORE_URL;
    });

    // Parse case ID from URL
    const params = new URLSearchParams(window.location.search);
    currentCaseId = params.get('id');

    if (!currentCaseId) {
        showError();
        return;
    }

    try {
        await loadCase(currentCaseId);
    } catch (err) {
        console.error('Failed to load case:', err);
        showError();
    }
}

// â”€â”€â”€ LOAD CASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function looksLikeUUID(value) {
    return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(value);
}

async function loadCase(caseId) {
    const matchField = looksLikeUUID(caseId) ? 'id' : 'case_number';

    // V65.0: Fetch duel fields alongside standard fields
    const { data: caseData, error: caseError } = await supabaseClient
        .from('cases')
        .select('id, case_number, title, snippet, full_story, category, is_duel, opponent_story')
        .eq(matchField, caseId)
        .single();

    if (caseError || !caseData) {
        showError();
        return;
    }

    // Always use the real uuid id for everything else
    const realCaseId = caseData.id;

    // Fetch combined vote stats
    const { data: stats } = await supabaseClient
        .from('combined_vote_stats')
        .select('*')
        .eq('case_id', realCaseId)
        .single();

    // â”€â”€ Detect Duel Mode â”€â”€
    const isDuel = caseData.is_duel === true
                && caseData.opponent_story
                && caseData.opponent_story.trim().length > 0;

    // â”€â”€ Populate the UI â”€â”€
    $title.textContent = caseData.title;

    if (isDuel) {
        // DUEL LAYOUT: show badge, tabs, both stories
        $duelBadge.classList.remove('hidden');
        $standardBody.classList.add('hidden');
        $duelBody.classList.remove('hidden');

        $duelStoryA.textContent = caseData.full_story || caseData.snippet;
        $duelStoryB.textContent = caseData.opponent_story;

        // Reset to Side A tab
        switchSide('a');
    } else {
        // STANDARD LAYOUT: same as before
        $body.textContent = caseData.full_story || caseData.snippet;
    }

    const totalVotes = stats ? stats.total_votes : 0;
    $totalVotes.textContent = totalVotes.toLocaleString();

    // â”€â”€ SERVER-SIDE dedup check â”€â”€
    let previousVote = null;

    try {
        const { data: existingVotes, error: checkErr } = await supabaseClient
            .from('web_votes')
            .select('vote')
            .eq('case_id', realCaseId)
            .eq('device_id', deviceId)
            .limit(1);

        if (!checkErr && existingVotes && existingVotes.length > 0) {
            const voteMap = {
                'youre_wrong': 'yta',
                'theyre_wrong': 'nta',
                'everyone_sucks': 'esh',
                'no_one_sucks': 'nah'
            };
            previousVote = voteMap[existingVotes[0].vote] || null;
        }
    } catch (e) {
        console.warn('Dedup check failed, falling back to localStorage:', e);
    }

    // Fallback: localStorage (covers old votes before device_id migration)
    if (!previousVote) {
        const storageKey = `aita_voted_${realCaseId}`;
        previousVote = localStorage.getItem(storageKey);
    }

    if (previousVote && stats) {
        showResults(stats, previousVote, true);
    }

    // Make sure the rest of the page uses the real uuid going forward
    currentCaseId = realCaseId;

    // Show the card, hide loading
    $loading.classList.add('hidden');
    $caseCard.classList.remove('hidden');
    $voteCounter.classList.remove('hidden');
}

// â”€â”€â”€ SELECT A VOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectVote(voteType) {
    if (isSubmitting) return;

    selectedVote = voteType;

    // Update UI selection
    document.querySelectorAll('.vote-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.vote === voteType);
    });

    // Enable submit button
    $submitBtn.disabled = false;
}

// â”€â”€â”€ SUBMIT VOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitVote() {
    if (!selectedVote || !currentCaseId || isSubmitting) return;

    isSubmitting = true;
    $submitBtn.disabled = true;
    $submitBtn.textContent = 'Submitting...';

    try {
        // Call the RPC function with device_id for anti-spam
        const { data, error } = await supabaseClient.rpc('vote_on_case_web', {
            p_case_id:   currentCaseId,
            p_vote_type: selectedVote,
            p_device_id: deviceId
        });

        if (error) throw error;
        if (data && !data.success) throw new Error(data.error);

        // Save to localStorage as backup
        localStorage.setItem(`aita_voted_${currentCaseId}`, selectedVote);

        // Show results (mark if server detected duplicate)
        showResults(data, selectedVote, data.already_voted);

        // Update total counter
        if (data && data.total_votes) {
            $totalVotes.textContent = data.total_votes.toLocaleString();
        }

    } catch (err) {
        console.error('Vote failed:', err);
        $submitBtn.textContent = 'Try Again';
        $submitBtn.disabled = false;
        isSubmitting = false;
    }
}

// â”€â”€â”€ SHOW RESULTS (App-Style Thick Pill Bars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResults(stats, userVote, wasDuplicate) {
    const yw  = stats.youre_wrong     || stats.youre_wrong_count     || 0;
    const tw  = stats.theyre_wrong    || stats.theyre_wrong_count    || 0;
    const es  = stats.everyone_sucks  || stats.everyone_sucks_count  || 0;
    const nos = stats.no_one_sucks    || stats.no_one_sucks_count    || 0;
    const total = (yw + tw + es + nos) || 1;

    const results = [
        { key: 'nta', label: "They're Wrong",   emoji: 'ğŸ‘', count: tw,  color: '#EF4444' },
        { key: 'yta', label: "You're Wrong",     emoji: 'ğŸš«', count: yw,  color: '#10B981' },
        { key: 'esh', label: 'Everyone Sucks',   emoji: 'ğŸ’¥', count: es,  color: '#F59E0B' },
        { key: 'nah', label: 'No One Sucks',     emoji: 'âœ…', count: nos, color: '#9CA3AF' },
    ];

    // Sort by count descending (winner on top)
    results.sort((a, b) => b.count - a.count);

    const headerText = wasDuplicate
        ? '<p class="text-base font-bold text-amber-600 mb-0.5">You already voted on this case</p><p class="text-sm text-gray-400">Here are the current results</p>'
        : '<p class="text-base font-bold text-green-600 mb-0.5">âœ“ Vote submitted!</p><p class="text-sm text-gray-400">Thanks for casting your judgment</p>';

    let barsHtml = '';
    results.forEach((r, i) => {
        const pct = Math.round((r.count / total) * 100);
        const isUser = r.key === userVote;
        const delay = i * 120;

        // Label (left side): white text when fill covers it (>= 25%), dark otherwise
        const onFill = pct >= 25;
        const lblColor = onFill ? '#ffffff' : '#374151';

        // Percentage (right side): ALWAYS dark/colored since it sits on the grey track
        // Only go white if fill is nearly full (>= 85%) so it actually covers the right edge
        const pctColor = pct >= 85 ? '#ffffff' : r.color;

        const badge = isUser
            ? `<span class="your-vote-pill" style="background:${onFill ? 'rgba(255,255,255,0.22)' : r.color + '15'}; color:${onFill ? '#fff' : r.color}">âœ“ you</span>`
            : '';

        const ringStyle = isUser ? `box-shadow: 0 0 0 2.5px ${r.color}44; ` : '';

        barsHtml += `
        <div style="margin-bottom: 10px; animation: fadeIn 0.4s ${delay}ms both;">
            <div class="result-bar-track" style="${ringStyle}">
                <div class="result-bar-fill"
                     style="min-width: 0%; background: ${r.color};"
                     data-width="${Math.max(pct, 4)}%"></div>
                <div class="result-bar-content">
                    <span class="result-bar-label" style="color: ${lblColor}">
                        ${r.emoji} ${r.label}${badge}
                    </span>
                    <span class="result-bar-pct" style="color: ${pctColor}">
                        ${pct}%
                    </span>
                </div>
            </div>
        </div>`;
    });

    const summaryHtml = `
        <div class="text-center mt-3 pt-3 border-t border-gray-100">
            <p class="text-xs text-gray-400 font-medium">${total.toLocaleString()} total vote${total !== 1 ? 's' : ''}</p>
        </div>`;

    $voteSection.classList.add('hidden');
    $results.innerHTML = `
        <div class="text-center mb-5">${headerText}</div>
        ${barsHtml}
        ${summaryHtml}
    `;
    $results.classList.remove('hidden');

    // Animate bar fills
    requestAnimationFrame(() => {
        setTimeout(() => {
            document.querySelectorAll('.result-bar-fill').forEach(bar => {
                bar.style.minWidth = bar.dataset.width;
            });
        }, 100);
    });

    $totalVotes.textContent = total.toLocaleString();
    $voteCounter.classList.remove('hidden');
}

// â”€â”€â”€ SHOW ERROR STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError() {
    $loading.classList.add('hidden');
    $caseCard.classList.add('hidden');
    $errorState.classList.remove('hidden');
}
</script>

</body>
</html>
